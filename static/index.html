<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Points Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
    .top-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.25rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .points-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.25rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .main-table-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.5rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
    }
    .submit-btn-row {
        text-align: center;
        margin-bottom: 2rem;
    }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <nav class="mb-3">
        <a href="index.html" class="btn btn-outline-primary btn-sm me-2">Dashboard</a>
        <a href="behaviors.html" class="btn btn-outline-secondary btn-sm me-2">Behaviors Table</a>
        <a href="edit_behaviors.html" class="btn btn-outline-warning btn-sm">Edit Behaviors</a>
    </nav>
    <h1 class="mb-4">Points Management System</h1>
    <!-- 顶部区域 -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="top-card">
                <h3 class="mb-3">Add Points</h3>
                <div>
                    <div class="mb-2">
                        <label for="child" class="form-label">Name</label>
                        <select class="form-select" id="child" required></select>
                    </div>
                    <div id="week-range" class="fw-bold text-primary"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="points-card">
                <h3 class="mb-3">Current Points</h3>
                <div id="points-progress-list"></div>
            </div>
        </div>
    </div>
    <!-- 主体区域：行为表格 -->
    <div class="main-table-card">
        <div id="behaviors-checkbox-list"></div>
    </div>
    <!-- dashboard extension area -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-section">
                <h3>Dashboard (in development)</h3>
                <div id="dashboard-section">
                    <p>More features coming soon: points trends, history, statistics, and more.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Fetch and display points
function loadPoints() {
    fetch('/points').then(r => r.json()).then(data => {
        const div = document.getElementById('points-progress-list');
        div.innerHTML = '';
        const WEEKLY_GOAL = 4000;
        Object.entries(data).forEach(([child, obj]) => {
            const weekly = obj.weekly || 0;
            const total = obj.total || 0;
            const percent = Math.min(100, Math.round(weekly / WEEKLY_GOAL * 100));
            div.innerHTML += `
                <div class="mb-2">
                    <strong>${child}</strong>
                    <div class="progress" style="height: 24px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;">
                            ${weekly} / ${WEEKLY_GOAL} (This week)
                        </div>
                    </div>
                    <div class="small text-muted mt-1">Total: ${total}</div>
                    <div class="small text-info mt-1">
                        Every 4000 points can be redeemed for $20.
                    </div>
                </div>
            `;
        });
    });
}
let behaviorsData = [];
// Fetch and display behaviors
function loadBehaviors() {
    fetch('/behaviors').then(r => r.json()).then(data => {
        behaviorsData = data;
        if (document.getElementById('child').options.length > 0) {
            renderBehaviorsCheckboxList();
        }
    });
}
function getWeekRange() {
    const now = new Date();
    const day = now.getDay(); // 0=Sun, 6=Sat
    const sunday = new Date(now);
    sunday.setDate(now.getDate() - day);
    const saturday = new Date(now);
    saturday.setDate(now.getDate() + (6 - day));
    function fmt(d) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    return {start: sunday, end: saturday, text: `${fmt(sunday)} ~ ${fmt(saturday)}`};
}
function getStorageKey(child, behavior, type, idx) {
    const week = getWeekRange();
    let dateKey = '';
    if (type === 'daily') {
        const d = new Date(week.start);
        d.setDate(d.getDate() + idx);
        dateKey = d.toISOString().slice(0,10);
    } else if (type === 'weekly') {
        dateKey = week.text;
    } else if (type === 'occasionally') {
        dateKey = week.text + '-' + idx;
    }
    return `submitted_${child}_${behavior}_${type}_${dateKey}`;
}

// 清理本地存储中过期的提交记录
function cleanOldSubmissions() {
    const week = getWeekRange();
    const validPrefix = `submitted_`;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(validPrefix) && !key.includes(week.text)) {
            localStorage.removeItem(key);
        }
    }
}

// 保存和读取 Occasional 行为输入值
function getOccasionalKey(child, behavior) {
    return `occasional_${child}_${behavior}`;
}

// 保存和读取 checkbox 状态
function getCheckboxKey(child, behavior, type, idx) {
    return `checkbox_${child}_${behavior}_${type}_${idx}`;
}

// 标记为已提交/未提交，并保存checkbox状态
function setCheckboxState(child, behavior, type, idx, checked) {
    const key = getStorageKey(child, behavior, type, idx);
    const ckey = getCheckboxKey(child, behavior, type, idx);
    if (checked) {
        localStorage.setItem(key, '1');
        localStorage.setItem(ckey, '1');
    } else {
        localStorage.removeItem(key);
        localStorage.removeItem(ckey);
    }
}

// 检查是否已提交（兼容老数据）
function isSubmitted(child, behavior, type, idx) {
    const ckey = getCheckboxKey(child, behavior, type, idx);
    return !!localStorage.getItem(ckey) || !!localStorage.getItem(getStorageKey(child, behavior, type, idx));
}

// 渲染表格时，checkbox 只根据 checked 状态
function renderBehaviorsCheckboxList() {
    cleanOldSubmissions();
    const week = getWeekRange();
    document.getElementById('week-range').textContent = `This week: ${week.text}`;
    const child = document.getElementById('child') ? document.getElementById('child').value : '';
    const groups = {daily: [], weekly: [], occasionally: []};
    behaviorsData.forEach(b => {
        if (groups[b.frequency]) groups[b.frequency].push(b);
    });
    const container = document.getElementById('behaviors-checkbox-list');
    container.innerHTML = '';

    let hasTable = false;

    // Daily
    if (groups.daily.length) {
        hasTable = true;
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Daily Behavior</th>
            <th class="text-center">Sun</th>
            <th class="text-center">Mon</th>
            <th class="text-center">Tue</th>
            <th class="text-center">Wed</th>
            <th class="text-center">Thu</th>
            <th class="text-center">Fri</th>
            <th class="text-center">Sat</th>
            <th>Points/Day</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.daily.forEach((b, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div>${b.name}</div>
                </td>
                ${[0,1,2,3,4,5,6].map(i => {
                    const checked = (child && isSubmitted(child, b.name, 'daily', i)) ? 'checked' : '';
                    return `<td class="text-center">
                        <input type="checkbox" class="form-check-input"
                            name="daily-${idx}" data-behavior="${b.name}" data-points="${b.points}" data-day="${i}" ${checked}>
                    </td>`;
                }).join('')}
                <td>${b.points}</td>
                <td><span class="text-muted small">${b.desc}</span></td>
            `;
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title mt-4 mb-2 fw-bold';
        title.textContent = 'Daily Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);
    }
    // Weekly
    if (groups.weekly.length) {
        hasTable = true;
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Weekly Behavior</th>
            <th class="text-center">Done This Week</th>
            <th>Points</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.weekly.forEach((b, idx) => {
            const checked = (child && isSubmitted(child, b.name, 'weekly', 0)) ? 'checked' : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div>${b.name}</div>
                </td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                        name="weekly-${idx}" data-behavior="${b.name}" data-points="${b.points}" ${checked}>
                </td>
                <td>${b.points}</td>
                <td><span class="text-muted small">${b.desc}</span></td>
            `;
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title mt-4 mb-2 fw-bold';
        title.textContent = 'Weekly Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);
    }
    // Occasionally
    if (groups.occasionally.length) {
        hasTable = true;
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Occasional Behavior</th>
            <th class="text-center">Count</th>
            <th>Points/Time</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.occasionally.forEach((b, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div>${b.name}</div>
                </td>
                <td class="text-center">
                    <input type="number" min="0" value="0" class="form-control form-control-sm occasional-count-input"
                        data-behavior="${b.name}" data-points="${b.points}" style="width:70px;display:inline-block;">
                </td>
                <td>${b.points}</td>
                <td><span class="text-muted small">${b.desc}</span></td>
            `;
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title mt-4 mb-2 fw-bold';
        title.textContent = 'Occasional Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);
    }

    if (!hasTable) {
        container.innerHTML = '<div class="alert alert-warning">No behaviors found.</div>';
    }

    // 绑定 checkbox 状态变化事件
    container.querySelectorAll('input[type=checkbox]').forEach(cb => {
        const behavior = cb.getAttribute('data-behavior');
        const type = cb.name.startsWith('daily') ? 'daily' : (cb.name.startsWith('weekly') ? 'weekly' : '');
        const idx = cb.name.startsWith('daily') ? cb.getAttribute('data-day') : 0;
        // 恢复checkbox状态
        const ckey = getCheckboxKey(child, behavior, type, idx);
        cb.checked = !!localStorage.getItem(ckey);

        cb.addEventListener('change', function() {
            setCheckboxState(child, behavior, type, idx, cb.checked);
            // 只提交本次变化的积分
            const delta = cb.checked ? Number(cb.getAttribute('data-points')) : -Number(cb.getAttribute('data-points'));
            updatePointsForChild(child, delta);
        });
    });
    // 绑定 occasional 行为输入框事件
    const lastOccasionalValues = {}; // 用于记录每个行为上次的值

    container.querySelectorAll('.occasional-count-input').forEach(input => {
        const behavior = input.getAttribute('data-behavior');
        // 恢复当前 child 的输入值
        const saved = localStorage.getItem(getOccasionalKey(child, behavior));
        let lastValue = saved !== null ? parseInt(saved) : 0;
        input.value = lastValue;
        lastOccasionalValues[behavior] = lastValue;

        input.addEventListener('change', function() {
            const newValue = Math.max(0, parseInt(input.value) || 0);
            const delta = (newValue - lastOccasionalValues[behavior]) * Number(input.getAttribute('data-points'));
            lastOccasionalValues[behavior] = newValue;
            // 保存到 localStorage
            localStorage.setItem(getOccasionalKey(child, behavior), newValue);
            if (delta !== 0) {
                updatePointsForChild(child, delta);
            }
        });
    });
}

// Fetch children and fill dropdown
function loadChildren() {
    fetch('/children').then(r => r.json()).then(children => {
        const select = document.getElementById('child');
        select.innerHTML = '';
        children.forEach(child => {
            const opt = document.createElement('option');
            opt.value = child.name;
            opt.textContent = `${child.name} (${child.cn})`;
            select.appendChild(opt);
        });
        if (children.length > 0) {
            select.value = children[0].name;
        }
        if (behaviorsData.length > 0) {
            renderBehaviorsCheckboxList();
        }
    });
}

// 监听孩子切换时刷新表格
document.getElementById('child').addEventListener('change', function() {
    renderBehaviorsCheckboxList();
});

// 初始化
loadPoints();
loadBehaviors();
loadChildren();

function updatePointsForChild(child, delta) {
    fetch(`/points/${encodeURIComponent(child)}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({amount: delta})
    }).then(r => r.json()).then(() => {
        loadPoints();
    });
}
</script>
</body>
</html>
