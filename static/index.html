<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Points Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
    .top-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.25rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .points-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.25rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .main-table-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 1.5rem 1rem 1rem 1rem;
        margin-bottom: 1.5rem;
    }
    .submit-btn-row {
        text-align: center;
        margin-bottom: 2rem;
    }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <nav class="mb-3">
        <a href="index.html" class="btn btn-outline-primary btn-sm me-2">Dashboard</a>
        <a href="behaviors.html" class="btn btn-outline-secondary btn-sm me-2">Behaviors Table</a>
        <a href="edit_behaviors.html" class="btn btn-outline-warning btn-sm">Edit Behaviors</a>
    </nav>
    <h1 class="mb-4">Points Management System</h1>
    <!-- 顶部区域 -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="top-card">
                <h3 class="mb-3">Add Points</h3>
                <form id="batch-points-form-top" autocomplete="off">
                    <div class="mb-2">
                        <label for="child" class="form-label">Name</label>
                        <select class="form-select" id="child" required></select>
                    </div>
                    <div id="week-range" class="fw-bold text-primary"></div>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <div class="points-card">
                <h3 class="mb-3">Current Points</h3>
                <ul id="points-list" class="list-unstyled mb-0"></ul>
            </div>
        </div>
    </div>
    <!-- 主体区域：行为表格 -->
    <form id="batch-points-form">
        <div class="main-table-card">
            <div id="behaviors-checkbox-list"></div>
        </div>
        <div class="submit-btn-row">
            <button type="submit" class="btn btn-primary btn-lg">Submit Selected Behaviors</button>
        </div>
    </form>
    <!-- dashboard extension area -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-section">
                <h3>Dashboard (in development)</h3>
                <div id="dashboard-section">
                    <p>More features coming soon: points trends, history, statistics, and more.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Fetch and display points
function loadPoints() {
    fetch('/points').then(r => r.json()).then(data => {
        const ul = document.getElementById('points-list');
        ul.innerHTML = '';
        Object.entries(data).forEach(([child, pts]) => {
            const li = document.createElement('li');
            li.className = 'points-list-item';
            li.textContent = `${child}: ${pts} pts`;
            ul.appendChild(li);
        });
    });
}
let behaviorsData = [];
// Fetch and display behaviors
function loadBehaviors() {
    fetch('/behaviors').then(r => r.json()).then(data => {
        behaviorsData = data;
        renderBehaviorsCheckboxList();
    });
}
function getWeekRange() {
    const now = new Date();
    const day = now.getDay(); // 0=Sun, 6=Sat
    const sunday = new Date(now);
    sunday.setDate(now.getDate() - day);
    const saturday = new Date(now);
    saturday.setDate(now.getDate() + (6 - day));
    function fmt(d) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    return {start: sunday, end: saturday, text: `${fmt(sunday)} ~ ${fmt(saturday)}`};
}
function renderBehaviorsCheckboxList() {
    const week = getWeekRange();
    document.getElementById('week-range').textContent = `This week: ${week.text}`;
    // 分组
    const groups = {daily: [], weekly: [], occasionally: []};
    behaviorsData.forEach(b => {
        if (groups[b.frequency]) groups[b.frequency].push(b);
    });
    const container = document.getElementById('behaviors-checkbox-list');
    container.innerHTML = '';
    // Daily
    if (groups.daily.length) {
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Daily Behavior</th>
            <th class="text-center">Sun</th>
            <th class="text-center">Mon</th>
            <th class="text-center">Tue</th>
            <th class="text-center">Wed</th>
            <th class="text-center">Thu</th>
            <th class="text-center">Fri</th>
            <th class="text-center">Sat</th>
            <th>Points/Day</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.daily.forEach((b, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${b.name}</td>
                ${[0,1,2,3,4,5,6].map(i =>
                    `<td class="text-center">
                        <input type="checkbox" class="form-check-input"
                            name="daily-${idx}" data-behavior="${b.name}" data-points="${b.points}" data-day="${i}">
                    </td>`
                ).join('')}
                <td>${b.points}</td>
                <td><span class="text-muted small">${b.desc}</span></td>
            `;
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title';
        title.textContent = 'Daily Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);
    }
    // Weekly
    if (groups.weekly.length) {
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Weekly Behavior</th>
            <th class="text-center">Done This Week</th>
            <th>Points</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.weekly.forEach((b, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${b.name}</td>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                        name="weekly-${idx}" data-behavior="${b.name}" data-points="${b.points}">
                </td>
                <td>${b.points}</td>
                <td><span class="text-muted small">${b.desc}</span></td>
            `;
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title';
        title.textContent = 'Weekly Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);
    }
    // Occasionally
    if (groups.occasionally.length) {
        const tbl = document.createElement('table');
        tbl.className = 'table table-bordered table-sm mb-4';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
            <th>Occasional Behavior</th>
            <th class="text-center">#1</th>
            <th class="text-center">#2</th>
            <th class="text-center">#3</th>
            <th>Points/Time</th>
            <th>Description</th>
        </tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        groups.occasionally.forEach((b, idx) => {
            const tr = document.createElement('tr');
            if (b.name === "Redeem 5 min screen time") {
                // 用输入框代替checkbox
                tr.innerHTML = `
                    <td>${b.name}</td>
                    <td colspan="3" class="text-center">
                        <input type="number" min="1" value="1" class="form-control form-control-sm redeem-screen-input" 
                            data-behavior="${b.name}" data-points="${b.points}" style="width:70px;display:inline-block;">
                        <span class="ms-2 text-danger" id="redeem-total-${idx}">Total: ${b.points}</span>
                    </td>
                    <td>${b.points}</td>
                    <td><span class="text-muted small">${b.desc}</span></td>
                `;
            } else {
                tr.innerHTML = `
                    <td>${b.name}</td>
                    ${[0,1,2].map(i =>
                        `<td class="text-center">
                            <input type="checkbox" class="form-check-input"
                                name="occasionally-${idx}" data-behavior="${b.name}" data-points="${b.points}" data-idx="${i}">
                        </td>`
                    ).join('')}
                    <td>${b.points}</td>
                    <td><span class="text-muted small">${b.desc}</span></td>
                `;
            }
            tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        const title = document.createElement('div');
        title.className = 'frequency-title';
        title.textContent = 'Occasional Behaviors';
        container.appendChild(title);
        container.appendChild(tbl);

        // 监听兑换份数输入，动态显示总扣分
        const redeemInput = tbl.querySelector('.redeem-screen-input');
        if (redeemInput) {
            redeemInput.addEventListener('input', function() {
                let n = Math.max(1, parseInt(this.value) || 1);
                this.value = n;
                const pts = Number(this.getAttribute('data-points'));
                const total = n * pts;
                document.getElementById('redeem-total-0').textContent = `Total: ${total}`;
            });
        }
    }
}
// Fetch children and fill dropdown
function loadChildren() {
    fetch('/children').then(r => r.json()).then(children => {
        const select = document.getElementById('child');
        select.innerHTML = '';
        children.forEach(child => {
            const opt = document.createElement('option');
            opt.value = child.name;
            opt.textContent = `${child.name} (${child.cn})`;
            select.appendChild(opt);
        });
    });
}
// 批量提交
document.getElementById('batch-points-form').onsubmit = function(e) {
    e.preventDefault();
    const child = document.getElementById('child').value;
    // 统计所有勾选
    let total = 0;
    const checked = Array.from(document.querySelectorAll('#behaviors-checkbox-list input[type=checkbox]:checked'));
    checked.forEach(cb => {
        total += Number(cb.getAttribute('data-points'));
    });
    // 统计兑换屏幕时间
    const redeemInput = document.querySelector('.redeem-screen-input');
    if (redeemInput) {
        let n = Math.max(1, parseInt(redeemInput.value) || 1);
        total += n * Number(redeemInput.getAttribute('data-points'));
    }
    if (total === 0) return alert('Please select at least one behavior');
    fetch(`/points/${encodeURIComponent(child)}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({amount: total})
    }).then(r => r.json()).then(() => {
        loadPoints();
        // 清空所有勾选和输入
        checked.forEach(cb => cb.checked = false);
        if (redeemInput) {
            redeemInput.value = 1;
            document.getElementById('redeem-total-0').textContent = `Total: ${Number(redeemInput.getAttribute('data-points'))}`;
        }
    });
};
// Init
loadPoints();
loadBehaviors();
loadChildren();
</script>
</body>
</html>
